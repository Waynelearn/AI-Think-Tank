<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Think Tank â€” Admin</title>
    <link rel="stylesheet" href="/static/theme.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-page); color: var(--text-primary); padding: 1.5rem; min-height: 100vh;
        }
        a { color: var(--accent-sky); text-decoration: none; }
        a:hover { text-decoration: underline; }
        header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1.5rem; flex-wrap: wrap; gap: 0.5rem;
        }
        h1 { font-size: 1.4rem; }
        .back-link { font-size: 0.85rem; }
        .header-right { display: flex; align-items: center; gap: 0.5rem; }
        .theme-toggle-admin {
            background: var(--bg-raised);
            border: 1px solid var(--border-muted);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.15rem 0.4rem;
            min-width: 2rem;
        }
        .theme-toggle-admin:hover { border-color: var(--accent-blue); }

        /* Date filter */
        .filter-bar {
            display: flex; gap: 0.6rem; align-items: center; margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        .filter-bar label { font-size: 0.8rem; color: var(--text-dim); }
        .filter-bar input[type="date"] {
            background: var(--bg-raised); border: 1px solid var(--border-muted); color: var(--text-primary);
            padding: 0.35rem 0.5rem; border-radius: 6px; font-size: 0.85rem;
        }
        .filter-bar button {
            background: var(--accent-blue); color: #fff; border: none; padding: 0.4rem 1rem;
            border-radius: 6px; cursor: pointer; font-size: 0.85rem;
        }
        .filter-bar button:hover { opacity: 0.9; }
        .filter-bar .clear-btn { background: var(--border-muted); }
        .filter-bar .clear-btn:hover { background: var(--text-faint); }

        /* Summary cards */
        .cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .card {
            background: var(--bg-raised); border-radius: 10px; padding: 1rem;
            border: 1px solid var(--border-default);
        }
        .card-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.3rem; }
        .card-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-sky); }
        .card-value.cost { color: var(--accent-yellow); }

        /* Tables */
        .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-secondary); }
        table {
            width: 100%; border-collapse: collapse; margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }
        th {
            text-align: left; padding: 0.5rem 0.6rem; border-bottom: 2px solid var(--border-muted);
            color: var(--text-dim); font-weight: 600; text-transform: uppercase; font-size: 0.7rem;
            letter-spacing: 0.05em;
        }
        td {
            padding: 0.5rem 0.6rem; border-bottom: 1px solid var(--border-default);
        }
        tr:hover td { background: var(--bg-raised); }
        .num { text-align: right; font-variant-numeric: tabular-nums; }
        .cost-cell { color: var(--accent-yellow); font-weight: 600; }
        .status-active { color: var(--accent-green); }
        .status-ended { color: var(--text-dim); }
        .topic-cell { max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .loading { text-align: center; color: var(--text-dim); padding: 2rem; }
        .error-msg { color: var(--accent-red); text-align: center; padding: 1rem; }

        @media (max-width: 600px) {
            body { padding: 0.8rem; }
            .cards { grid-template-columns: 1fr 1fr; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.35rem 0.4rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Usage Dashboard</h1>
        <div class="header-right">
            <a href="/" class="back-link">&larr; Back to Think Tank</a>
            <button class="theme-toggle-admin" id="btn-theme-admin" aria-label="Toggle theme" title="Toggle theme"><span id="theme-icon-admin">&#9790;</span></button>
        </div>
    </header>

    <div class="filter-bar">
        <label for="start-date">From</label>
        <input type="date" id="start-date">
        <label for="end-date">To</label>
        <input type="date" id="end-date">
        <button id="btn-filter">Filter</button>
        <button id="btn-clear-filter" class="clear-btn">Clear</button>
    </div>

    <div id="content">
        <div class="loading">Loading usage data...</div>
    </div>

    <script src="/static/utils.js?v=3"></script>
    <script>
        const contentEl = document.getElementById("content");
        const startDateInput = document.getElementById("start-date");
        const endDateInput = document.getElementById("end-date");

        // Theme toggle
        (function() {
            const saved = localStorage.getItem("thinktank_theme");
            const prefer = window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
            const theme = saved || prefer;
            document.documentElement.setAttribute("data-theme", theme);
            const icon = document.getElementById("theme-icon-admin");
            if (icon) icon.innerHTML = theme === "light" ? "&#9728;" : "&#9790;";

            document.getElementById("btn-theme-admin").addEventListener("click", () => {
                const current = document.documentElement.getAttribute("data-theme") || "dark";
                const next = current === "dark" ? "light" : "dark";
                document.documentElement.setAttribute("data-theme", next);
                localStorage.setItem("thinktank_theme", next);
                if (icon) icon.innerHTML = next === "light" ? "&#9728;" : "&#9790;";
            });
        })();

        function formatCost(c) {
            if (c < 0.01) return "$" + c.toFixed(4);
            return "$" + c.toFixed(2);
        }

        async function loadUsage() {
            const params = new URLSearchParams();
            if (startDateInput.value) params.set("start_date", startDateInput.value);
            if (endDateInput.value) params.set("end_date", endDateInput.value);

            contentEl.innerHTML = '<div class="loading">Loading usage data...</div>';

            try {
                const res = await fetch(`/api/admin/usage?${params}`);
                const data = await res.json();
                renderDashboard(data);
            } catch (e) {
                contentEl.innerHTML = '<div class="error-msg">Failed to load usage data.</div>';
            }
        }

        function renderDashboard(data) {
            const totalCost = data.total_estimated_cost || 0;
            const totalIn = data.total_input_tokens || 0;
            const totalOut = data.total_output_tokens || 0;
            const totalSessions = data.total_sessions || 0;

            let html = `
                <div class="cards">
                    <div class="card">
                        <div class="card-label">Sessions</div>
                        <div class="card-value">${totalSessions}</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Input Tokens</div>
                        <div class="card-value">${formatTokens(totalIn)}</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Output Tokens</div>
                        <div class="card-value">${formatTokens(totalOut)}</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Estimated Cost</div>
                        <div class="card-value cost">${formatCost(totalCost)}</div>
                    </div>
                </div>
            `;

            // By provider/model
            if (data.by_provider && data.by_provider.length) {
                html += `<div class="section-title">By Provider / Model</div>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Provider</th>
                            <th scope="col">Model</th>
                            <th scope="col" class="num">Sessions</th>
                            <th scope="col" class="num">Input</th>
                            <th scope="col" class="num">Output</th>
                            <th scope="col" class="num">Cost</th>
                        </tr>
                    </thead>
                    <tbody>`;
                for (const r of data.by_provider) {
                    html += `<tr>
                        <td>${escapeHtml(r.provider || "\u2014")}</td>
                        <td>${escapeHtml(r.model || "\u2014")}</td>
                        <td class="num">${r.sessions}</td>
                        <td class="num">${formatTokens(r.input_tokens || 0)}</td>
                        <td class="num">${formatTokens(r.output_tokens || 0)}</td>
                        <td class="num cost-cell">${formatCost(r.cost || 0)}</td>
                    </tr>`;
                }
                html += `</tbody></table>`;
            }

            // Recent sessions
            if (data.recent_sessions && data.recent_sessions.length) {
                html += `<div class="section-title">Recent Sessions</div>
                <table>
                    <thead>
                        <tr>
                            <th scope="col">Topic</th>
                            <th scope="col">Provider</th>
                            <th scope="col">Model</th>
                            <th scope="col">Status</th>
                            <th scope="col" class="num">Input</th>
                            <th scope="col" class="num">Output</th>
                            <th scope="col" class="num">Cost</th>
                            <th scope="col">Date</th>
                        </tr>
                    </thead>
                    <tbody>`;
                for (const s of data.recent_sessions) {
                    const statusClass = s.status === "active" ? "status-active" : "status-ended";
                    html += `<tr>
                        <td class="topic-cell" title="${escapeHtml(s.topic)}">${escapeHtml(s.topic)}</td>
                        <td>${escapeHtml(s.provider || "\u2014")}</td>
                        <td>${escapeHtml(s.model || "\u2014")}</td>
                        <td class="${statusClass}">${s.status}</td>
                        <td class="num">${formatTokens(s.input_tokens || 0)}</td>
                        <td class="num">${formatTokens(s.output_tokens || 0)}</td>
                        <td class="num cost-cell">${formatCost(s.total_cost || 0)}</td>
                        <td>${formatDate(s.created_at)}</td>
                    </tr>`;
                }
                html += `</tbody></table>`;
            }

            if (!data.by_provider?.length && !data.recent_sessions?.length && totalSessions === 0) {
                html += '<div class="loading">No usage data yet. Start a discussion to generate receipts.</div>';
            }

            contentEl.innerHTML = html;
        }

        document.getElementById("btn-filter").addEventListener("click", loadUsage);
        document.getElementById("btn-clear-filter").addEventListener("click", () => {
            startDateInput.value = "";
            endDateInput.value = "";
            loadUsage();
        });

        loadUsage();
    </script>
</body>
</html>
